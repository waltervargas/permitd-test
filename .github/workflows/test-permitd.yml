name: Test permitd

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  test-permitd:
    runs-on: ubuntu-latest
    steps:
      - name: Get OIDC token
        id: oidc
        run: |
          TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=permitd" | jq -r '.value')
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Health check
        run: |
          curl -sv https://apps.walt3r.dev/healthz 2>&1
          echo ""

      - name: List containers (authenticated)
        run: |
          curl -sv \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            https://apps.walt3r.dev/v5.0.0/libpod/containers/json 2>&1
          echo ""

      - name: List images (authenticated)
        run: |
          curl -sv \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            https://apps.walt3r.dev/v5.0.0/libpod/images/json 2>&1
          echo ""

      - name: Attempt unauthorized action (should fail)
        run: |
          curl -sv \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            -X POST \
            https://apps.walt3r.dev/v5.0.0/libpod/containers/create 2>&1
          echo ""
